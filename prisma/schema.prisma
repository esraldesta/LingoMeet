// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  role          String?
  banned        Boolean?  @default(false)
  banReason     String?
  banExpires    DateTime?
  sessions      Session[]
  accounts      Account[]
  professional  Professional?

  @@unique([email])
  @@map("user")
}

model Session {
  id             String   @id
  expiresAt      DateTime
  token          String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  ipAddress      String?
  userAgent      String?
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  impersonatedBy String?

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model RateLimit {
  id          String  @id
  key         String?
  count       Int?
  lastRequest BigInt?

  @@map("rateLimit")
}

model Room {
  id                String    @id @default(uuid()) 
  name              String
  description       String?
  roomType          String     @default("general")
  language          String
  topic             String?
  isPublic          Boolean    @default(true) 
  maxParticipants   Int        @default(10) 
  createdBy         String     
  teacherId         String?     
  status            String     @default("active")
  scheduledStartTime DateTime? 
  createdAt         DateTime   @default(now()) 
  updatedAt         DateTime   @updatedAt 

  participants      RoomParticipant[]
  // messages          RoomMessage[]
  // studentProgress   StudentProgress[]

  @@index([createdBy])
  @@index([teacherId])
  @@index([status])
  @@map("rooms")

}

model RoomParticipant {
  id        String    @id @default(uuid()) 
  roomId    String    
  userId    String    
  joinedAt  DateTime  @default(now()) 
  leftAt    DateTime? 
  role      String    @default("participant")

  room      Room      @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([userId])
  @@map("room_participants")
}

model Professional {
  id                String    @id @default(uuid()) 
  userId            String    @unique 
  displayName       String    
  bio               String?
  avatarUrl         String?   
  languages         String[]  
  certifications    String[]  
  experience        String?   
  accent            String?   
  level             String    
  pricePerMinute    Float     
  isVerified        Boolean   @default(false) 
  verificationDate  DateTime? 
  rating            Float?    @default(0)
  reviewCount       Int       @default(0) 
  totalSessions     Int       @default(0) 
  createdAt         DateTime  @default(now()) 
  updatedAt         DateTime  @updatedAt 

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions          ProfessionalSession[]
  bookings          Booking[]
  reviews           ProfessionalReview[]
  availability      ProfessionalAvailability[]

  @@index([isVerified])
  @@index([rating])
  @@index([languages])
  @@map("professionals")
}

model ProfessionalAvailability {
  id            String    @id @default(uuid()) 
  professionalId String    
  dayOfWeek     Int       
  startTime     String    
  endTime       String    
  isAvailable   Boolean   @default(true) 
  createdAt     DateTime  @default(now()) 
  updatedAt     DateTime  @updatedAt

  professional  Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@unique([professionalId, dayOfWeek, startTime])
}

model ProfessionalSession {
  id             String    @id @default(uuid()) 
  professionalId String    
  title          String?
  description    String?
  language       String
  maxParticipants Int      @default(1) 
  pricePerMinute Float     
  status         String    @default("scheduled") 
  scheduledStart DateTime  
  scheduledEnd   DateTime  
  actualStart    DateTime? 
  actualEnd      DateTime? 
  meetingUrl     String?   
  createdAt      DateTime  @default(now()) 
  updatedAt      DateTime  @updatedAt

  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  booking        Booking?
  participants   SessionParticipant[]

  @@index([professionalId])
  @@index([status])
  @@index([scheduledStart])
  @@map("professional_sessions")
}

model Booking {
  id             String    @id @default(uuid()) 
  professionalId String    
  sessionId      String    @unique
  learnerId      String    
  status         String    @default("pending") 
  totalPrice     Float     
  platformFee    Float     
  professionalEarnings Float 
  paymentStatus  String    @default("pending") 
  paymentId      String?   
  bookedAt       DateTime  @default(now()) 
  confirmedAt    DateTime? 
  cancelledAt    DateTime? 
  completedAt    DateTime? 
  notes          String?
  createdAt      DateTime  @default(now()) 
  updatedAt      DateTime  @updatedAt

  professional   Professional         @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  session        ProfessionalSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  review         ProfessionalReview?

  @@index([professionalId])
  @@index([learnerId])
  @@index([status])
  @@index([paymentStatus])
  @@map("bookings")
}

model SessionParticipant {
  id         String    @id @default(uuid()) 
  sessionId  String    
  userId     String    
  joinedAt   DateTime  @default(now()) 
  leftAt     DateTime? 
  role       String    @default("learner")

  session    ProfessionalSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@map("session_participants")
}

model ProfessionalReview {
  id            String    @id @default(uuid()) 
  professionalId String    
  bookingId     String    @unique    
  learnerId     String    
  rating        Int       
  comment       String?
  isPublic      Boolean   @default(true) 
  createdAt     DateTime  @default(now()) 
  updatedAt     DateTime  @updatedAt

  professional  Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  booking       Booking?    @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([professionalId])
  @@index([rating])
  @@map("professional_reviews")
}
