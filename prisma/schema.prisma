// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  role          String?
  banned        Boolean?  @default(false)
  banReason     String?
  banExpires    DateTime?
  sessions      Session[]
  accounts      Account[]
  
  professional  Professional?
  
  bookings      Booking[]      @relation("LearnerBookings")
  reviewsWritten Review[]      @relation("LearnerReviews")

  @@unique([email])
  @@map("user")
}

model Session {
  id             String   @id
  expiresAt      DateTime
  token          String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  ipAddress      String?
  userAgent      String?
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  impersonatedBy String?

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model RateLimit {
  id          String  @id
  key         String?
  count       Int?
  lastRequest BigInt?

  @@map("rateLimit")
}

model Room {
  id                String    @id @default(uuid()) 
  name              String
  description       String?
  roomType          String     @default("general")
  language          String
  topic             String?
  isPublic          Boolean    @default(true) 
  maxParticipants   Int        @default(10) 
  createdBy         String     
  teacherId         String?     
  status            String     @default("active")
  scheduledStartTime DateTime? 
  createdAt         DateTime   @default(now()) 
  updatedAt         DateTime   @updatedAt 

  participants      RoomParticipant[]
  
  booking           Booking?

  @@index([createdBy])
  @@index([teacherId])
  @@index([status])
  @@map("rooms")

}

model RoomParticipant {
  id        String    @id @default(uuid()) 
  roomId    String    
  userId    String    
  joinedAt  DateTime  @default(now()) 
  leftAt    DateTime? 
  role      String    @default("participant")

  room      Room      @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([userId])
  @@map("room_participants")
}

// --- Professional Marketplace Models ---

model Professional {
  id            String    @id @default(uuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  bio           String?
  headline      String?
  languages     Json?     // e.g. [{"language": "Spanish", "level": "Native"}, {"language": "English", "level": "C1"}]
  pricePerMinute Decimal  @default(0.0)
  currency      String    @default("USD")
  
  isVerified    Boolean   @default(false)
  
  rating        Float     @default(0.0)
  reviewCount   Int       @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  availabilities Availability[]
  bookings       Booking[]
  reviews        Review[]
  
  @@map("professionals")
}

model Availability {
  id             String       @id @default(uuid())
  professionalId String
  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  
  dayOfWeek      Int          // 0 = Sunday, 1 = Monday, etc.
  startTime      String       // "09:00" (24h format)
  endTime        String       // "17:00"
  
  // For specific dates overrides (optional for now, but good to have)
  specificDate   DateTime?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@map("availabilities")
}

model Booking {
  id             String       @id @default(uuid())
  learnerId      String
  learner        User         @relation("LearnerBookings", fields: [learnerId], references: [id])
  
  professionalId String
  professional   Professional @relation(fields: [professionalId], references: [id])
  
  roomId         String?      @unique
  room           Room?        @relation(fields: [roomId], references: [id])
  
  startTime      DateTime
  endTime        DateTime
  durationMinutes Int
  
  totalPrice     Decimal
  currency       String       @default("USD")
  
  status         String       @default("pending") // pending, confirmed, completed, canceled
  paymentStatus  String       @default("unpaid")  // unpaid, paid, refunded
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  review         Review?

  @@map("bookings")
}

model Review {
  id             String       @id @default(uuid())
  bookingId      String       @unique
  booking        Booking      @relation(fields: [bookingId], references: [id])
  
  learnerId      String
  learner        User         @relation("LearnerReviews", fields: [learnerId], references: [id])
  
  professionalId String
  professional   Professional @relation(fields: [professionalId], references: [id])
  
  rating         Int          // 1-5
  comment        String?
  
  createdAt      DateTime     @default(now())
  
  @@map("reviews")
}